<Window x:Class="HysteryVPN.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:h="http://helix-toolkit.org/wpf"
        xmlns:local="clr-namespace:HysteryVPN"
        Title="HysteryVPN" Height="650" Width="1000"
        Background="{StaticResource BackgroundBrush}" WindowStartupLocation="CenterScreen"
        ResizeMode="CanResizeWithGrip"
        FontFamily="Segoe UI">

    <Window.Resources>
        <!-- Цветовая палитра (Dark Mode) -->
        <SolidColorBrush x:Key="BackgroundBrush" Color="#1E1E1E"/>
        <SolidColorBrush x:Key="SidebarBrush" Color="#252526"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#3E3E42"/>
        <SolidColorBrush x:Key="PrimaryTextBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="SecondaryTextBrush" Color="#AAAAAA"/>
        <SolidColorBrush x:Key="AccentBrush" Color="#2ECC71"/>
        
        <SolidColorBrush x:Key="ButtonBackgroundBrush" Color="#2D2D30"/>
        <SolidColorBrush x:Key="ButtonForegroundBrush" Color="#FFFFFF"/>
        
        <SolidColorBrush x:Key="TextBoxBackgroundBrush" Color="#333337"/>
        <SolidColorBrush x:Key="TextBoxForegroundBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="TextBoxBorderBrush" Color="#434346"/>
        
        <SolidColorBrush x:Key="LogBackgroundBrush" Color="#1E1E1E"/>
        <SolidColorBrush x:Key="LogTextBrush" Color="#00FF00"/>
        <!-- Стиль для Toggle Switch (Слайдер вместо CheckBox) -->
        <Style x:Key="ToggleSwitchStyle" TargetType="CheckBox">
            <Setter Property="Foreground" Value="{StaticResource SecondaryTextBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <StackPanel Orientation="Horizontal">
                            <Grid x:Name="SwitchRoot" Width="34" Height="18" VerticalAlignment="Center">
                                <Border x:Name="Background" Background="#434346" CornerRadius="9" />
                                <Ellipse x:Name="Thumb" Fill="White" Width="12" Height="12" HorizontalAlignment="Left" Margin="3,0">
                                    <Ellipse.RenderTransform>
                                        <TranslateTransform X="0"/>
                                    </Ellipse.RenderTransform>
                                </Ellipse>
                            </Grid>
                            <ContentPresenter Margin="10,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Background" Property="Background" Value="{StaticResource AccentBrush}"/>
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="Thumb"
                                                             Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                                                             To="16" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="Thumb"
                                                             Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                                                             To="0" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Background" Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- === ЛЕВАЯ ПАНЕЛЬ (САЙДБАР) === -->
        <Border Grid.Column="0" Background="{StaticResource SidebarBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Лого -->
                    <RowDefinition Height="Auto"/> <!-- Статус и кнопка -->
                    <RowDefinition Height="Auto"/> <!-- Поле ссылки -->
                    <RowDefinition Height="*"/>    <!-- Лог -->
                    <RowDefinition Height="Auto"/> <!-- Нижнее -->
                </Grid.RowDefinitions>

                <!-- 1. Header -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20,20,20,10">
                    <TextBlock Text="Hystery" FontWeight="Bold" FontSize="20" Foreground="{StaticResource PrimaryTextBrush}"/>
                    <TextBlock Text=" VPN" FontWeight="Normal" FontSize="20" Foreground="{StaticResource AccentBrush}"/>
                </StackPanel>

                <!-- 2. Status Area -->
                <StackPanel Grid.Row="1" Margin="20,10">
                    <TextBlock Name="StatusText" Text="Not connected" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" Margin="0,0,0,5"/>
                    <TextBlock Name="ProtectionStatusText" Text="You are unprotected" Foreground="{StaticResource PrimaryTextBrush}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,15"/>

                    <Button Name="ActionBtn" Content="CONNECT" Height="40" Background="{StaticResource ButtonBackgroundBrush}" Foreground="{StaticResource ButtonForegroundBrush}" FontSize="14" FontWeight="Bold" Click="ActionBtn_Click">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" CornerRadius="20" Padding="15,10">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Opacity" Value="0.9"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>

                    <StackPanel Name="ConnectionProgressPanel" Orientation="Horizontal" Margin="0,10,0,0" Visibility="Collapsed">
                        <TextBlock Name="ConnectionStatusText" Text="Connecting..." Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <Border Background="{StaticResource SidebarBrush}" CornerRadius="3" Padding="1" VerticalAlignment="Center">
                            <ProgressBar Name="ConnectionProgressBar" Height="4" Width="118" IsIndeterminate="True" Background="Transparent" Foreground="{StaticResource AccentBrush}" BorderThickness="0"/>
                        </Border>
                    </StackPanel>
                </StackPanel>

                <!-- 3. Link Input -->
                <StackPanel Grid.Row="2" Margin="20,10">
                    <TextBlock Text="Hysteria 2 Link (hy2://)" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" Margin="0,0,0,5"/>
                    <TextBox Name="LinkInput" Height="35"
                               Background="{StaticResource TextBoxBackgroundBrush}" Foreground="{StaticResource TextBoxForegroundBrush}" BorderThickness="1" BorderBrush="{StaticResource TextBoxBorderBrush}"
                               Padding="5" VerticalContentAlignment="Center"
                               Text=""/>

                    <StackPanel Orientation="Horizontal" Margin="0,15,0,0">
                        <TextBlock Text="Enable TURN Relay" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <CheckBox Name="EnableTurnToggle" Style="{StaticResource ToggleSwitchStyle}" VerticalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                        <TextBlock Text="Enable Zapret (DPI Bypass)" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <CheckBox Name="EnableZapretToggle" Style="{StaticResource ToggleSwitchStyle}" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <!-- 4. Log -->
                <Grid Grid.Row="3">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="Connection Log:" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" Margin="20,0,0,5"/>
                    <TextBox Name="LogText" Grid.Row="1"
                               Background="{StaticResource LogBackgroundBrush}" Foreground="{StaticResource LogTextBrush}"
                               FontFamily="Consolas" FontSize="12"
                               TextWrapping="Wrap"
                               IsReadOnly="True"
                               VerticalScrollBarVisibility="Auto"
                               BorderThickness="0"
                               Padding="20,10"
                               AcceptsReturn="True"/>
                </Grid>

                <!-- 5. Bottom -->
                <Border Grid.Row="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0" Padding="20">
                    <TextBlock Text="HysteryVPN v1.0" Foreground="{StaticResource SecondaryTextBrush}" HorizontalAlignment="Center"/>
                </Border>
            </Grid>
        </Border>

        <!-- === ПРАВАЯ ПАНЕЛЬ (КАРТА) === -->
        <Grid Grid.Column="1" Background="{StaticResource BackgroundBrush}" ClipToBounds="True" x:Name="MapContainer" SizeChanged="MapContainer_SizeChanged">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <ComboBox x:Name="MapTypeSelector" SelectionChanged="MapTypeSelector_SelectionChanged" HorizontalAlignment="Right" Margin="10" Width="120" Grid.Row="0" Panel.ZIndex="1">
                <ComboBoxItem Content="2D Map" IsSelected="True"/>
                <ComboBoxItem Content="3D Globe"/>
            </ComboBox>
            <!-- Canvas теперь имеет прозрачный фон, чтобы ловить клики -->
            <Canvas x:Name="MapRoot" Background="Transparent" Grid.Row="1"
                    MouseWheel="MapRoot_MouseWheel"
                    MouseDown="MapRoot_MouseDown"
                    MouseMove="MapRoot_MouseMove"
                    MouseUp="MapRoot_MouseUp">
                <Canvas.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform x:Name="MapScaleTransform" ScaleX="1.0" ScaleY="1.0"/>
                        <TranslateTransform x:Name="MapTranslateTransform"/>
                    </TransformGroup>
                </Canvas.RenderTransform>

                <!-- Vector map canvas -->
                <Canvas x:Name="VectorMapCanvas" Background="Transparent"/>
                <Canvas x:Name="MapCanvas"/>
            </Canvas>
            <local:MapboxStyleGlobe x:Name="GlobeContainer" Grid.Row="1" Visibility="Collapsed"/>
            
            <!-- Панель управления глобусом -->
            <Border x:Name="GlobeControls" Grid.Row="1" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="20" Background="#1A1A1A" CornerRadius="8" Opacity="0.95" Width="200" Visibility="Collapsed">
                <StackPanel Margin="15">
                    <TextBlock Text="GLOBE VIEW" Foreground="#808080" FontSize="11" FontWeight="Bold"/>
                    <Separator Background="#333333" Margin="0,5,0,10"/>
                    <CheckBox Content="Atmosphere glow" Foreground="White" IsChecked="True" Checked="ToggleAtmosphere_Checked" Unchecked="ToggleAtmosphere_Checked"/>
                    <CheckBox Content="Star field" Foreground="White" Margin="0,5,0,0" IsChecked="True" Checked="ToggleStars_Checked" Unchecked="ToggleStars_Checked"/>
                    <TextBlock Text="Rotation speed" Foreground="White" Margin="0,10,0,5"/>
                    <Slider x:Name="RotationSpeedSlider" Minimum="0" Maximum="2" Value="0" TickFrequency="0.1" ValueChanged="RotationSpeed_ValueChanged"/>
                    <Button Content="Reset View" Background="#333333" Foreground="White" BorderThickness="0" Margin="0,10,0,0" Padding="10,5" Click="ResetView_Click"/>
                </StackPanel>
            </Border>

            <!-- Панель статистики внизу -->
            <Border Grid.Row="1" VerticalAlignment="Bottom" Height="80" Background="{StaticResource SidebarBrush}" Margin="20" CornerRadius="10" Opacity="0.9">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <TextBlock Text="CONNECTION" Foreground="{StaticResource SecondaryTextBrush}" FontSize="10"/>
                        <TextBlock Name="ConnectionText" Text="---" Foreground="{StaticResource PrimaryTextBrush}" FontSize="14" FontWeight="Bold"/>
                    </StackPanel>

                    <Rectangle Grid.Column="1" Width="1" Fill="{StaticResource BorderBrush}" Margin="0,15"/>

                    <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <TextBlock Text="IP ADDRESS" Foreground="{StaticResource SecondaryTextBrush}" FontSize="10"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Image Name="CountryFlag" Width="16" Height="16" Margin="0,0,5,0" Visibility="Collapsed"/>
                            <TextBlock Name="IpText" Text="Unprotected" Foreground="{StaticResource PrimaryTextBrush}" FontSize="14"/>
                        </StackPanel>
                    </StackPanel>

                    <Rectangle Grid.Column="3" Width="1" Fill="{StaticResource BorderBrush}" Margin="0,15"/>

                    <StackPanel Grid.Column="4" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <TextBlock Text="PROTOCOL" Foreground="{StaticResource SecondaryTextBrush}" FontSize="10"/>
                        <TextBlock Text="Hysteria" Foreground="{StaticResource PrimaryTextBrush}" FontSize="14"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>