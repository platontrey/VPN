# Hysteria2 VPN - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ

### 1. Orchestrator Service (Master Server)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: `orchestrator-service/`
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VPS —É–∑–ª–∞–º–∏ —á–µ—Ä–µ–∑ gRPC
  - REST API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Redis
  - –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–ü–æ—Ä—Ç—ã**: 8081 (REST), 50052 (gRPC)

### 2. Agent Service (VPS Nodes)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: `agent-service/`
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ master-—Å–µ—Ä–≤–µ—Ä–µ
  - Periodic heartbeat –∏ –æ—Ç—á–µ—Ç—ã –æ —Å—Ç–∞—Ç—É—Å–µ
  - –°–±–æ—Ä –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
  - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –æ—Ç master
- **–ü–æ—Ä—Ç—ã**: 50051 (gRPC), 8080/udp (Hysteria2)

### 3. gRPC –ü—Ä–æ—Ç–æ–∫–æ–ª—ã
- **–§–∞–π–ª**: `proto/node_management.proto`
- **–°–µ—Ä–≤–∏—Å—ã**:
  - `NodeManager`: Master ‚Üí Node –∫–æ–º–∞–Ω–¥—ã
  - `MasterService`: Node ‚Üí Master –æ—Ç—á–µ—Ç—ã
  - `AdminService`: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí Master

### 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: `migrations/001_create_nodes_tables.sql`
- **–¢–∞–±–ª–∏—Ü—ã**:
  - `vps_nodes` - —Ä–µ–µ—Å—Ç—Ä —É–∑–ª–æ–≤
  - `node_assignments` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∑–ª–∞–º
  - `node_metrics` - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - `deployments` - –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π

### 5. Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **–û—Å–Ω–æ–≤–Ω–æ–π**: `deployments/docker/docker-compose.yml`
- **–°–µ—Ä–≤–∏—Å—ã**: PostgreSQL, Redis, Orchestrator, API, Web, 3 VPS Agent
- **–ü—Ä–æ–∫—Å–∏**: Nginx –¥–ª—è production
- **Health checks**: –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### 6. –°–∫—Ä–∏–ø—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- **`scripts/dev-start.sh`**: –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **`scripts/deploy.sh`**: Production —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- **`Makefile`**: –£–¥–æ–±–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º
- **`scripts/generate-proto.sh`**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC –∫–æ–¥–∞

### 7. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º
```bash
# –ü–æ–ª–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
make dev-full

# –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
make dev-start

# –°–æ–∑–¥–∞–Ω–∏–µ protobuf
make proto

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make test-all

# Production —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
make deploy

# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤
make scale-agents COUNT=5
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    gRPC     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Master Server  ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ   VPS Node 1    ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Orchestrator  ‚îÇ             ‚îÇ ‚Ä¢ Agent Service ‚îÇ
‚îÇ ‚Ä¢ API Service   ‚îÇ             ‚îÇ ‚Ä¢ Hysteria2     ‚îÇ
‚îÇ ‚Ä¢ Web UI       ‚îÇ             ‚îÇ ‚Ä¢ Metrics       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                               ‚îÇ
         ‚îÇ HTTP/WebSocket                ‚îÇ
         ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    gRPC     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Users         ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ   VPS Node 2    ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Web Panel     ‚îÇ             ‚îÇ ‚Ä¢ Agent Service ‚îÇ
‚îÇ ‚Ä¢ Mobile App    ‚îÇ             ‚îÇ ‚Ä¢ Hysteria2     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üåç –ì–µ–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤:
- **US East**: –ù—å—é-–ô–æ—Ä–∫
- **Europe**: –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç  
- **Asia**: –°–∏–Ω–≥–∞–ø—É—Ä

### –ü–æ—Ä—Ç—ã –¥–æ—Å—Ç—É–ø–∞:
- **US East Agent**: grpc://localhost:50061
- **Europe Agent**: grpc://localhost:50062
- **Asia Agent**: grpc://localhost:50063

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
# –ü–æ–ª–Ω–∞—è —Å—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
make dev-full

# –ò–ª–∏ –ø–æ —à–∞–≥–∞–º
make dev-setup    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
make proto        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC
make docker-build # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
make docker-run   # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
```

### 2. Production
```bash
# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
make deploy

# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
make scale-agents COUNT=10

# –ë—ç–∫–∞–ø
make db-backup

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
make health
```

## üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

- **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: http://localhost:3000
- **API**: http://localhost:8080
- **Orchestrator**: http://localhost:8081
- **gRPC Master**: localhost:50052
- **PostgreSQL**: localhost:5432
- **Redis**: localhost:6379

## üîß –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make logs-all              # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make logs-orchestrator     # –¢–æ–ª—å–∫–æ orchestrator
make logs-agents          # –¢–æ–ª—å–∫–æ VPS –∞–≥–µ–Ω—Ç—ã

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
make db-migrate           # –ú–∏–≥—Ä–∞—Ü–∏–∏
make db-backup           # –ë—ç–∫–∞–ø
make db-restore BACKUP=backup.sql

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make test-unit            # Unit —Ç–µ—Å—Ç—ã
make test-all             # –í—Å–µ —Ç–µ—Å—Ç—ã

# –û—á–∏—Å—Ç–∫–∞
make clean                # –£–¥–∞–ª–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
make dev-stop            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å gRPC –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - –ø–æ–ª–Ω–∞—è –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è proto —Å–µ—Ä–≤–∏—Å–æ–≤
2. **–û–±–Ω–æ–≤–∏—Ç—å API —Å–µ—Ä–≤–∏—Å** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å orchestrator
3. **–î–æ–±–∞–≤–∏—Ç—å React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∑–ª–∞–º–∏
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - Prometheus + Grafana
5. **–î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** - mTLS –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏
6. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - CI/CD pipeline

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **gRPC —Å TLS**: —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É master –∏ nodes
- **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –¥–ª—è REST API
- **Rate limiting**: –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS
- **Health checks**: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Network isolation**: Docker —Å–µ—Ç–∏

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö VPS —É–∑–ª–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞**: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ì–µ–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å**: —É–∑–ª—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö
- **–í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å**: —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ VPN —Å–∏—Å—Ç–µ–º—ã Hysteria2 —Å:

- ‚úÖ **Master-Node –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º** –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ **gRPC –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–µ–π** –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–≤—è–∑–∏
- ‚úÖ **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–µ–π** –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è  
- ‚úÖ **–ü–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π** —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç—ã –∏ Makefile
- ‚úÖ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å—é –∫ production** —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∏ –±—ç–∫–∞–ø–∞–º–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏ –º–æ–∂–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–æ —Å–æ—Ç–µ–Ω VPS —É–∑–ª–æ–≤ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É!